{% extends "base.html" %}
{% load static %}


{% block headblock %}
    <link rel="stylesheet" href="{% static 'datamanager_page.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock headblock %}
    


{% block bodyblock %}
    <section class="top-bar">
        <div class="top-bar-title">
            <h1 class="roboto-bold">Welcome To Well-E Data Manager</h1>
            <svg width="65" height="60" viewBox="0 0 65 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.00434113 26.9604L7.80138 25.6712C8.28096 24.8429 9.09691 24.1663 10.1537 23.824C10.2861 23.7813 10.4206 23.7443 10.5552 23.7132L19.2875 8.22978C18.4586 6.73841 18.3522 4.95537 19.1725 3.33761C20.6308 0.45598 24.4696 -0.800116 27.7464 0.531813L60.3299 12.4414C64.299 14.0553 66.0849 18.193 64.3185 21.6832C63.5655 23.1707 62.2895 24.2985 60.7639 24.981L48.898 51.1957L48.3946 52.3409C50.6927 54.2465 52.1314 56.9725 52.1314 60H28.838C28.838 54.2367 34.0526 49.5643 40.4847 49.5643C40.5064 49.5643 40.5259 49.5643 40.5476 49.5643L41.3788 47.5207L41.2486 47.5499L41.4764 47.2815L50.9878 23.8668L50.9965 23.7676L24.8125 12.0214L15.6158 26.0446C15.6288 26.0757 15.644 26.1048 15.6548 26.136C15.7265 26.3148 15.7829 26.4957 15.8241 26.6784L23.1546 30.6781L20.6894 32.6906L17.1175 39.5214L13.4718 40.13L14.9539 30.684L14.394 30.3826C14.0143 30.6723 13.5694 30.9076 13.0725 31.0689C11.1845 31.6814 9.12946 31.034 8.05311 29.6087L5.38176 38.7941L2.19611 37.0947L1.55811 30.402L1.25647 30.4506L0 26.9662L0.00434113 26.9604ZM58.1534 14.2283C55.3453 13.8122 52.6935 15.5136 52.2291 18.0297C51.7647 20.5457 53.6635 22.9218 56.4716 23.3379C59.2796 23.754 61.9314 22.0527 62.3958 19.5366C62.8602 17.0205 60.9614 14.6444 58.1534 14.2283ZM28.8575 6.27563C29.2047 4.39538 27.7855 2.62012 25.687 2.30901C23.9944 2.05818 22.3799 2.83595 21.6355 4.13288C21.5921 4.20871 21.5531 4.28455 21.5162 4.36232C21.5118 4.3701 21.5097 4.37788 21.5053 4.38371C21.4706 4.45954 21.4381 4.53538 21.4077 4.6151L21.4055 4.62093C21.3773 4.69676 21.3513 4.77648 21.3296 4.85426C21.3252 4.87176 21.3209 4.88926 21.3165 4.90482C21.2948 4.98454 21.2753 5.06426 21.2623 5.14592C21.1972 5.49786 21.195 5.84786 21.2471 6.18425C21.4728 7.64062 22.7292 8.86171 24.4327 9.11449C24.4957 9.12421 24.5564 9.13199 24.6172 9.13782C24.6367 9.13977 24.6563 9.14171 24.6758 9.14365C24.717 9.14754 24.7604 9.15143 24.8017 9.15338C24.8255 9.15532 24.8494 9.15532 24.8711 9.15727C24.9102 9.15921 24.947 9.16115 24.9839 9.16115C25.0078 9.16115 25.0317 9.16115 25.0577 9.16115C25.0946 9.16115 25.1315 9.16116 25.1684 9.15921C25.1923 9.15921 25.2161 9.15727 25.24 9.15727C25.2769 9.15532 25.3138 9.15338 25.3507 9.15143C25.3746 9.14949 25.3963 9.14754 25.4201 9.1456C25.4614 9.14171 25.5004 9.13782 25.5395 9.13393C25.559 9.13199 25.5785 9.13004 25.5981 9.1281C25.6567 9.12032 25.7131 9.11254 25.7717 9.10282H25.776C25.8324 9.0931 25.891 9.08143 25.9474 9.06977C25.967 9.06588 25.9865 9.06005 26.006 9.05616C26.0429 9.04838 26.082 9.03866 26.1189 9.02893C26.1406 9.0231 26.1645 9.01727 26.1862 9.01143C26.2209 9.00171 26.2534 8.99199 26.2881 8.98227C26.312 8.97449 26.3337 8.96866 26.3576 8.96088C26.3901 8.95116 26.4227 8.93949 26.4552 8.92782C26.4769 8.92005 26.5008 8.91227 26.5225 8.90449C26.5551 8.89282 26.5876 8.87921 26.6202 8.86755C26.6419 8.85977 26.6636 8.85005 26.6831 8.84227C26.7178 8.82866 26.7525 8.8131 26.7873 8.79755C26.8046 8.78977 26.822 8.78199 26.8393 8.77422C26.8893 8.75088 26.9413 8.7256 26.9891 8.70033L26.9913 8.69838C27.9504 8.19867 28.6622 7.33145 28.8575 6.27563Z" fill="#F2F2F2"/>
            </svg>
        </div>
        <div class="top-bar-buttons">
            <button id="patient-screen-button" class="roboto-bold default-button selected-button">PATIENT MANAGER</button>
            <button id="nurse-screen-button" class="roboto-bold default-button">NURSE MANAGER</button>
        </div>
    </section>

    <section id="patient-section" class="patient-section">
        <button id="add-patient-button" class=" roboto-bold">ADD PATIENT</button>
        <div class="patient-list"  id="patient-list"> 
            
        </div>
    </section>

    

    <section id="nurse-section" class="nurse-section"  style="display: none;">
        <button id="add-nurse-button" class=" roboto-bold">ADD NURSE</button>
        <div class="nurse-list" id="nurse-list"> 
            
        </div>
    </section>
    

    <div class="patient-add-form" style="display: none;">

        <div class="patient-fill-up-form">
            <h3 class="roboto-bold">ADD PATIENT</h3>
            <div class="patient-fill-line">
                <label  class="roboto-medium" for="patient-name">First Name *</label>
                <input type="text" id="patient-fname" name="patient-fname">
            </div>
            <div class="patient-fill-line">
                <label class="roboto-medium" for="patient-name">Middle Name *</label>
                <input type="text" id="patient-mname" name="patient-mname">
            </div>
            <div class="patient-fill-line">
                <label class="roboto-medium" for="patient-name">Last Name *</label>
                <input type="text" id="patient-lname" name="patient-lname">
            </div>
            <div class="patient-fill-line">
                <label class="roboto-medium" for="patient-image">Upload Face Image *</label>
                <input type="file" id="patient-image" name="patient-image" accept="image/*">
            </div>
            <div class="patient-fill-line">
                <label class="roboto-medium" for="patient-number">Emergency Phone Number *</label>
                <input type="text" id="patient-number" name="patient-number">
            </div>
            <div class="patient-fill-line">
                <label class="roboto-medium" for="patient-number">Patient Color *</label>
                <select name="patient-color" value='RED' id="patient-color">
                    <option value="RED">RED</option>
                    <option value="BLUE">BLUE</option>
                    <option value="YELLOW">YELLOW</option>
                </select>
                {% comment %} <input type="text" id="patient-number" name="patient-number"> {% endcomment %}
            </div>
            <div class="form-action-buttons">
                <button class="roboto-light" id="patient-confirm-button" >CONFIRM</button>
                <button class="roboto-light" id="patient-cancel-button" >CANCEL</button>
            </div>
        </div>
        
    </div>

    
    <div class="nurse-add-form" style="display: none;">

        <div class="nurse-fill-up-form">
            <h3 class="roboto-bold">ADD NURSE</h3>
            <div class="nurse-fill-line">
                <label  class="roboto-medium" for="nurse-name">First Name *</label>
                <input type="text" id="nurse-fname" name="nurse-name">
            </div>
            <div class="nurse-fill-line">
                <label class="roboto-medium" for="nurse-name">Middle Name *</label>
                <input type="text" id="nurse-mname" name="nurse-name">
            </div>
            <div class="nurse-fill-line">
                <label class="roboto-medium" for="nurse-name">Last Name *</label>
                <input type="text" id="nurse-lname" name="nurse-name">
            </div>
            <div class="nurse-fill-line">
                <label class="roboto-medium" for="nurse-image">Upload Face Image *</label>
                <input type="file" id="nurse-image" name="nurse-image" accept="image/*">
            </div>
            <div class="form-action-buttons">
                <button class="roboto-light" id="nurse-confirm-button" >CONFIRM</button>
                <button class="roboto-light" id="nurse-cancel-button" >CANCEL</button>
            </div>
        </div>
        
    </div>

    <script>
        const patient_screen_button = document.getElementById("patient-screen-button");
        const nurse_screen_button = document.getElementById("nurse-screen-button");
        
        const patient_section = document.getElementById("patient-section");
        const nurse_section = document.getElementById("nurse-section");

        const add_patient_button = document.getElementById("add-patient-button");
        const add_nurse_button = document.getElementById("add-nurse-button");
        
        const patient_add_form = document.querySelector(".patient-add-form");
        const nurse_add_form = document.querySelector(".nurse-add-form");

        const patient_confirm_button = document.getElementById("patient-confirm-button");
        const nurse_confirm_button = document.getElementById("nurse-confirm-button");
        
        const patient_cancel_button = document.getElementById("patient-cancel-button");
        const nurse_cancel_button = document.getElementById("nurse-cancel-button");

        const patient_list = document.getElementById("patient-list");
        const nurse_list = document.getElementById("nurse-list");
        
        patient_cancel_button.addEventListener("click", function () {
            patient_add_form.style.display = "none";
        });

        nurse_cancel_button.addEventListener("click", function () {
            nurse_add_form.style.display = "none";
        });
        
        add_patient_button.addEventListener("click", function () {
            patient_add_form.style.display = "flex";
            nurse_add_form.style.display = "none";
        });

        add_nurse_button.addEventListener("click", function () {
            nurse_add_form.style.display = "flex";
            patient_add_form.style.display = "none";
        });

        patient_screen_button.addEventListener("click", function () {
            patient_section.style.display = "flex";
            nurse_section.style.display = "none";
            patient_screen_button.classList.remove("selected-button");
            nurse_screen_button.classList.remove("selected-button");
            patient_screen_button.classList.add("selected-button");
        });
        
        nurse_screen_button.addEventListener("click", function () {
            nurse_section.style.display = "flex";
            patient_section.style.display = "none";
            nurse_screen_button.classList.remove("selected-button");
            patient_screen_button.classList.remove("selected-button");
            nurse_screen_button.classList.add("selected-button");
        });

        async function fetch_nurses_data(){

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const response = await fetch("fetch/nurses", {
                    method: "GET",
                    headers: {
                        "X-CSRFToken": csrfToken,
                    },
                });
                const data = await response.json();
                if (response.ok){
                    console.log(data);
                    data.nurses.forEach((nurse) =>{ 

                        // Parse the string into a Date object
                        const originalDate = new Date(nurse.date_added);

                        // Format the Date object into the desired string format
                        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                        const formattedDateStr = `${monthNames[originalDate.getMonth()]} ${originalDate.getDate()}, ${originalDate.getFullYear()}`;
 
                        nurse_list.insertAdjacentHTML('afterbegin', ` 
                            <div class="nurse-card">
                                <img src="${nurse.face}" alt="nurse">
                                <div class="nurse-info">
                                    <h3 class="roboto-medium">${nurse.name}</h3>
                                    <h5 class="roboto-light">Date Added : ${formattedDateStr}</h5>
                                    <div class="nurse-action-buttons">
                                        <button onclick="window.location.href='../nurse/${nurse.id}'">Check Nurse</button> 
                                        <button id="nurse-delete-${nurse.id}">Delete Nurse</button>
                                    </div>
                                </div>
                            </div>
                        `)
                        const deleteButton = document.getElementById(`nurse-delete-${nurse.id}`);
                        deleteButton.addEventListener("click", async function () {
                            // Handle delete nurse request here
                            const formData = new FormData();
                            formData.append('nurse_id', nurse.id);
                            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                            const response = await fetch(`delete/nurse`, {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": csrfToken,
                                },
                                body: formData,
                            });
                            const data = await response.json();
                            if (response.ok){
                                console.log(data);
                                deleteButton.parentNode.parentNode.parentNode.parentNode.removeChild(deleteButton.parentNode.parentNode.parentNode);
                            } else {
                                console.error('Server responded with status:', response.status);
                                console.error('Error:', data);
                            }
                        });
                    })
                } else {
                    console.error('Server responded with status:', response.status);
                    console.error('Error:', data);
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function fetch_patients_data(){

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const response = await fetch("fetch/patients", {
                    method: "GET",
                    headers: {
                        "X-CSRFToken": csrfToken,
                    },
                });
                const data = await response.json();
                if (response.ok){
                    console.log(data);
                    data.patients.forEach((patient) =>{ 

                        // Parse the string into a Date object
                        const originalDate = new Date(patient.date_added);

                        // Format the Date object into the desired string format
                        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                        const formattedDateStr = `${monthNames[originalDate.getMonth()]} ${originalDate.getDate()}, ${originalDate.getFullYear()}`;
 
                        patient_list.insertAdjacentHTML('afterbegin', ` 
                            <div class="patient-card">
                                <img src="${patient.face}" alt="nurse">
                                <div class="patient-info">
                                    <h3 class="roboto-medium">${patient.name}</h3>
                                    <h5 class="roboto-light">Date Added : ${formattedDateStr}</h5>
                                    <div class="patient-action-buttons">
                                        <button onclick="window.location.href='../patient/${patient.id}'">Edit Patient</button>
                                        <button id="patient-delete-${patient.id}">Delete Patient</button>
                                    </div>
                                </div>
                            </div>
                        `)

                        const deleteButton = document.getElementById(`patient-delete-${patient.id}`);
                        deleteButton.addEventListener("click", async function () {
                            // Handle delete nurse request here
                            const formData = new FormData();
                            formData.append('patient_id', patient.id);
                            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                            const response = await fetch(`delete/patient`, {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": csrfToken,
                                },
                                body: formData,
                            });
                            const data = await response.json();
                            if (response.ok){
                                console.log(data);
                                deleteButton.parentNode.parentNode.parentNode.parentNode.removeChild(deleteButton.parentNode.parentNode.parentNode);
                            } else {
                                console.error('Server responded with status:', response.status);
                                console.error('Error:', data);
                            }
                        });

                    })
                } else {
                    console.error('Server responded with status:', response.status);
                    console.error('Error:', data);
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }


        fetch_nurses_data();
        fetch_patients_data();


        patient_confirm_button.addEventListener("click", async function () {
            // Handle patient form submission here
            if (patient_confirm_button.disabled){
                return;
            }
            patient_confirm_button.disabled = true;

            const fname = document.getElementById("patient-fname").value
            const lname = document.getElementById("patient-lname").value
            const mname = document.getElementById("patient-mname").value
            const face_image = document.getElementById("patient-image").files[0]
            const phonenumber = document.getElementById("patient-number").value
            const patient_color = document.getElementById("patient-color").value

            if (!fname || !mname || !face_image || !lname || !phonenumber || !patient_color ){
                alert("Please fill all required fields.")
                patient_confirm_button.disabled = false;
                return;
            }

            const formData = new FormData();
            formData.append('face', face_image);
            formData.append('first_name', fname);
            formData.append('last_name', lname);
            formData.append('middle_name', mname);
            formData.append('phone_number', phonenumber);
            formData.append('color', patient_color);
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const response = await fetch("create/patient", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                },
                body: formData,
            });
            const data = await response.json();
            if (response.ok) { 
                setTimeout(() =>{
                    window.location.reload();
                },500);
            } else {
                console.error('Server responded with status:', response.status);
                console.error('Error:', data);
                patient_confirm_button.disabled = false;
                return;
            }

             
        });

        
        nurse_confirm_button.addEventListener("click", async function () {
            // Handle patient form submission here
            if (nurse_confirm_button.disabled){
                return;
            }
            nurse_confirm_button.disabled = true;

            const fname = document.getElementById("nurse-fname").value
            const lname = document.getElementById("nurse-lname").value
            const mname = document.getElementById("nurse-mname").value
            const face_image = document.getElementById("nurse-image").files[0]

            if (!fname || !mname || !face_image || !lname){
                alert("Please fill all required fields.")
                nurse_confirm_button.disabled = false;
                return;
            }

            const formData = new FormData();
            formData.append('face', face_image);
            formData.append('first_name', fname);
            formData.append('last_name', lname);
            formData.append('middle_name', mname);
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const response = await fetch("create/nurse", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                },
                body: formData,
            });
            const data = await response.json();
            if (response.ok) { 
                setTimeout(() =>{
                    window.location.reload();
                },500);
            } else {
                console.error('Server responded with status:', response.status);
                console.error('Error:', data);
                nurse_confirm_button.disabled = false;
                return;
            }

             
        });
        
    </script>

{% endblock bodyblock %}
